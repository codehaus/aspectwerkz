<project default="aspectwerkz:site"
    xmlns:m="maven" xmlns:jxr="jxr" xmlns:j="jelly:core" xmlns:u="jelly:util">

    <!-- =================================================== -->
    <!--  set properties -->
    <!-- =================================================== -->
    <property name="pathseparator" value=""/>
    <property name="executableSuffix" value=""/>

    <property name="target.dir" value="${basedir}/target"/>
    <property name="lib.dir" value="${basedir}/lib"/>
    <property name="bin.dir" value="${basedir}/bin"/>
    <property name="dist.dir" value="${basedir}/dist"/>

    <property name="main.classes" value="${target.dir}/classes"/>
    <property name="test.classes" value="${target.dir}/test-classes"/>
    <property name="samples.classes" value="${target.dir}/samples-classes"/>
    <property name="extensions.classes" value="${target.dir}/extensions-classes"/>

    <!-- =================================================== -->
    <!--  initializes parameters  -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:init">
        <mkdir dir="${basedir}/_metaData"/>
        <mkdir dir="${dist.dir}"/>
        <j:choose>
            <j:when test="${systemScope['os.name'].startsWith('Windows')}">
                <j:set var="pathseparator" value=";"/>
                <j:set var="executableSuffix" value=".bat"/>
            </j:when>
            <j:otherwise>
                <j:set var="pathseparator" value=":"/>
                <j:set var="executableSuffix" value=""/>
            </j:otherwise>
        </j:choose>
    </goal>

    <!-- =================================================== -->
    <!--  generates reports and deploys site -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:site">
        <attainGoal name="clean"/>
        <attainGoal name="aspectwerkz:init"/>
        <attainGoal name="site:deploy"/>
    </goal>

    <!-- =================================================== -->
    <!--  compiles the core distribution and makes a jar file including all the libraries -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:jar">
        <attainGoal name="aspectwerkz:init"/>
        <attainGoal name="java:compile"/>
        <jar jarfile="${target.dir}/aspectwerkz-${pom.currentVersion}.jar">
            <fileset dir="${main.classes}">
                <exclude name="**/aspectwerkz/hook/**/*" />
            </fileset>
        </jar>
        <copy tofile="${lib.dir}/aspectwerkz-${pom.currentVersion}.jar" file="${target.dir}/aspectwerkz-${pom.currentVersion}.jar" overwrite="true"/>

        <!-- split dist for layer 1 separation -->
        <jar jarfile="${target.dir}/aspectwerkz-core-${pom.currentVersion}.jar">
            <fileset dir="${main.classes}">
                <include name="**/aspectwerkz/hook/**/*" />
            </fileset>
        </jar>
        <copy tofile="${lib.dir}/aspectwerkz-core-${pom.currentVersion}.jar" file="${target.dir}/aspectwerkz-core-${pom.currentVersion}.jar" overwrite="true"/>

        <!--        <jar destfile="${dist.dir}/aspectwerkz-${pom.currentVersion}.jar" manifest="${config.dir}/MANIFEST.MF">-->
        <!--            <fileset dir="${main.classes}"/>-->
        <!--            <fileset dir="${lib.dir}" excludes="aspectwerkz-${pom.currentVersion}.jar" includes="jmangler-core.jar bcel.jar dom4j-1.4.jar qdox4j-1.2.jar trove-1.0.2.jar concurrent-1.3.1.jar prevayler-2.00.000dev1.jar"/>-->
        <!--            <manifest>-->
        <!--                <attribute name="Built-By" value="jboner"/>-->
        <!--                <section name="aspectwerkz">-->
        <!--                    <attribute name="Implementation-Title" value="AspectWerkz"/>-->
        <!--                    <attribute name="Implementation-Version" value="${pom.currentVersion}"/>-->
        <!--                    <attribute name="Implementation-Vendor" value="jboner"/>-->
        <!--                    <attribute name="Class-Path" value="jmangler-core.jar bcel.jar dom4j-1.4.jar qdox-1.2.jar trove-1.0.2.jar concurrent-1.3.1.jar prevayler-2.00.000dev1.jar"/>-->
        <!--                </section>-->
        <!--            </manifest>-->
        <!--        </jar>-->
    </goal>

    <!-- =================================================== -->
    <!--  compiles everything -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:compile">
        <attainGoal name="aspectwerkz:init"/>
        <attainGoal name="aspectwerkz:jar"/>
        <attainGoal name="aspectwerkz:extensions:compile"/>
        <attainGoal name="aspectwerkz:samples:compile"/>
        <attainGoal name="test:compile"/>
    </goal>

    <!-- =================================================== -->
    <!--  transforms and runs tests -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:test">
        <attainGoal name="aspectwerkz:init"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:test"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-cp ${test.classes}${pathseparator}${samples.classes}${pathseparator}${lib.dir}/junit-3.8.1.jar -Daspectwerkz.metadata.dir=${basedir}/_metaData test.AllTests"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  transforms the samples -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:transform">
        <attainGoal name="clean"/>
        <attainGoal name="aspectwerkz:init"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-offline ${samples.classes} ${basedir}/src/samples/samples.xml ${basedir}/_metaData"/>
        </exec>
    </goal>

    <goal name="aspectwerkz:transform:logging">
        <attainGoal name="aspectwerkz:transform"/>
        <java classname="examples.logging.Target" fork="true">
            <jvmarg value="-Daspectwerkz.metadata.dir=${basedir}/_metaData"/>
            <classpath>
                <pathelement path="${samples.classes}"/>
                <pathelement path="${main.classes}"/>
                <fileset dir="${lib.dir}">
                    <include name="*.jar"></include>
                </fileset>
            </classpath>
        </java>
    </goal>


    <!-- =================================================== -->
    <!--  compiles the samples -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:compile">
        <attainGoal name="aspectwerkz:init"/>
        <mkdir dir="${samples.classes}"/>

        <javac destdir="${samples.classes}" deprecation="true"
            debug="true" optimize="false" excludes="**/samples.xml">
            <src>
                <pathelement location="src/samples"></pathelement>
            </src>
            <classpath>
                <pathelement path="${main.classes}"/>
                <fileset dir="${lib.dir}">
                    <include name="*.jar"></include>
                </fileset>
                <fileset dir="${dist.dir}">
                    <include name="*.jar"></include>
                </fileset>
            </classpath>
        </javac>
        <jar jarfile="${target.dir}/samples.jar" basedir="${samples.classes}"/>
        <copy tofile="${dist.dir}/samples.jar" file="${target.dir}/samples.jar" overwrite="true"/>
    </goal>

    <!-- =================================================== -->
    <!--  compiles the extensions -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:extensions:compile">
        <attainGoal name="aspectwerkz:init"/>
        <mkdir dir="${extensions.classes}"/>

        <javac destdir="${extensions.classes}" deprecation="true"
            debug="true" optimize="false" excludes="**/*.xml">
            <src>
                <pathelement location="src/extensions"></pathelement>
            </src>
            <classpath>
                <pathelement path="${main.classes}"/>
                <fileset dir="${lib.dir}">
                    <include name="*.jar"></include>
                </fileset>
                <fileset dir="${dist.dir}">
                    <include name="*.jar"></include>
                </fileset>
            </classpath>
        </javac>
        <jar jarfile="${target.dir}/extensions.jar" basedir="${extensions.classes}"/>
        <copy tofile="${dist.dir}/extensions.jar" file="${target.dir}/extensions.jar" overwrite="true"/>
    </goal>

    <!-- =================================================== -->
    <!--  runs the transparent persistence test -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:transparentpersistence">
        <attainGoal name="aspectwerkz:init"/>
        <delete dir="${basedir}/_txLogs"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples:extensions"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}" fork="false">
            <arg line="-cp ${dist.dir}/extensions.jar${pathseparator}${dist.dir}/samples.jar${pathseparator}${lib.dir}/jisp-2.0.1.jar -Daspectwerkz.extension.persistence.definition.file=${basedir}/src/samples/persistence_definition.xml -Daspectwerkz.metadata.dir=${basedir}/_metaData examples.transparentpersistence.Client"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  runs the introduction test -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:introduction">
        <attainGoal name="aspectwerkz:init"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-cp ${lib.dir}/picocontainer-1.0-SNAPSHOT.jar${pathseparator}${dist.dir}/extensions.jar${pathseparator}${lib.dir}/ant-1.5.2.jar${pathseparator}${dist.dir}/samples.jar -Daspectwerkz.metadata.dir=${basedir}/_metaData examples.introduction.Target"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  runs the caching test -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:caching">
        <attainGoal name="aspectwerkz:init"/>
        <delete dir="${basedir}/_txLogs"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-cp ${dist.dir}/extensions.jar${pathseparator}${dist.dir}/samples.jar -Daspectwerkz.metadata.dir=${basedir}/_metaData examples.caching.CacheTest"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  runs the logging test -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:logging">
        <attainGoal name="aspectwerkz:init"/>
        <delete dir="${basedir}/_txLogs"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-cp ${dist.dir}/extensions.jar${pathseparator}${dist.dir}/samples.jar -Daspectwerkz.metadata.dir=${basedir}/_metaData examples.logging.Target"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  runs the asynchronous calls test -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:asynchronous">
        <attainGoal name="aspectwerkz:init"/>
        <delete dir="${basedir}/_txLogs"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-cp ${dist.dir}/extensions.jar${pathseparator}${dist.dir}/samples.jar -Daspectwerkz.metadata.dir=${basedir}/_metaData examples.asynchronous.Target"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  runs the synchronization test -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:synchronization">
        <attainGoal name="aspectwerkz:init"/>
        <delete dir="${basedir}/_txLogs"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-cp ${dist.dir}/extensions.jar${pathseparator}${dist.dir}/samples.jar${pathseparator}${lib.dir}/commons-collections-2.1.jar -Daspectwerkz.metadata.dir=${basedir}/_metaData examples.synchronization.Target"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  runs the cflow test -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:samples:cflow">
        <attainGoal name="aspectwerkz:init"/>
        <delete dir="${basedir}/_txLogs"/>
        <attainGoal name="aspectwerkz:compile"/>
        <attainGoal name="aspectwerkz:metadata:samples"/>
        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">
            <arg line="-cp ${dist.dir}/extensions.jar${pathseparator}${dist.dir}/samples.jar${pathseparator}${lib.dir}/commons-collections-2.1.jar -Daspectwerkz.metadata.dir=${basedir}/_metaData examples.cflow.Target"/>
        </exec>
        <delete dir="${basedir}/_metaData"/>
    </goal>

    <!-- =================================================== -->
    <!--  downloads dependencies -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:getdeps">
        <attainGoal name="aspectwerkz:init"/>
        <mkdir dir="${lib.dir}"/>
        <copy todir="${lib.dir}" flatten="true">
            <fileset dir="${maven.repo.local}">
                <j:forEach var="dep" items="${pom.dependencies}">
                    <include name="${dep.projectId}/jars/${dep.jar}"/>
                </j:forEach>
            </fileset>
        </copy>
    </goal>

    <!-- =================================================== -->
    <!--  compiles meta-data for the tests -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:metadata:test">
        <attainGoal name="aspectwerkz:init"/>
        <exec executable="java">
            <arg line="-cp ${main.classes}${pathseparator}${lib.dir}/qdox-1.2.jar${pathseparator}${lib.dir}/dom4j-1.4.jar${pathseparator}${lib.dir}/trove-1.0.2.jar${pathseparator}${lib.dir}/bcel.jar${pathseparator}${lib.dir}/commons-jexl-1.0-beta-2.jar org.codehaus.aspectwerkz.metadata.SourceFileMetaDataCompiler ${basedir}/src/test/aspectwerkz-test.xml ${basedir}/src/test ${basedir}/_metaData tests"/>
        </exec>
    </goal>

    <!-- =================================================== -->
    <!--  compiles meta-data for the samples -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:metadata:samples">
        <attainGoal name="aspectwerkz:init"/>
        <exec executable="java">
            <arg line="-cp ${main.classes}${pathseparator}${lib.dir}/qdox-1.2.jar${pathseparator}${lib.dir}/dom4j-1.4.jar${pathseparator}${lib.dir}/trove-1.0.2.jar${pathseparator}${lib.dir}/bcel.jar${pathseparator}${lib.dir}/commons-jexl-1.0-beta-2.jar org.codehaus.aspectwerkz.metadata.SourceFileMetaDataCompiler ${basedir}/src/samples/samples.xml ${basedir}/src/samples ${basedir}/_metaData"/>
        </exec>
    </goal>

    <!-- =================================================== -->
    <!--  compiles meta-data for the extension samples -->
    <!-- =================================================== -->
    <goal name="aspectwerkz:metadata:samples:extensions">
        <attainGoal name="aspectwerkz:init"/>
        <exec executable="java">
            <arg line="-cp ${main.classes}${pathseparator}${lib.dir}/qdox-1.2.jar${pathseparator}${lib.dir}/dom4j-1.4.jar${pathseparator}${lib.dir}/trove-1.0.2.jar${pathseparator}${lib.dir}/bcel.jar${pathseparator}${lib.dir}/commons-jexl-1.0-beta-2.jar org.codehaus.aspectwerkz.metadata.SourceFileMetaDataCompiler ${basedir}/src/samples/extensions_samples.xml ${basedir}/src/samples ${basedir}/_metaData extensions"/>
        </exec>
    </goal>



<!--    <goal name="bugshow">-->
<!--        <exec executable="java">-->
<!--            <arg line="-cp C:/temp/bugshow;${lib.dir}/aspectwerkz-0.7.jar${pathseparator}${lib.dir}/commons-jexl-1.0-beta-2.jar${pathseparator}${lib.dir}/concurrent-1.3.1.jar${pathseparator}${lib.dir}/qdox-1.2.jar${pathseparator}${lib.dir}/dom4j-1.4.jar${pathseparator}${lib.dir}/trove-1.0.2.jar${pathseparator}${lib.dir}/bcel.jar${pathseparator}${lib.dir}/jmangler-core.jar -Daspectwerkz.metadata.dir=c:/temp/bugshow/_metaData test.Test 100 c:/temp/bugshow/test3.xml"/>-->
<!--        </exec>-->
<!--    </goal>-->
<!--    <goal name="aspectwerkz:metadata:bugshow">-->
<!--        <attainGoal name="aspectwerkz:init"/>-->
<!--        <exec executable="java">-->
<!--            <arg line="-cp ${lib.dir}/aspectwerkz-0.7.jar${pathseparator}${lib.dir}/qdox-1.2.jar${pathseparator}${lib.dir}/dom4j-1.4.jar${pathseparator}${lib.dir}/trove-1.0.2.jar${pathseparator}${lib.dir}/bcel.jar${pathseparator}${lib.dir}/jmangler-core.jar${pathseparator}${lib.dir}/commons-jexl-1.0-beta-2.jar org.codehaus.aspectwerkz.metadata.SourceFileMetaDataCompiler C:/temp/bugshow/aspectwerkz.xml C:/temp/bugshow C:/temp/bugshow/_metaData default"/>-->
<!--        </exec>-->
<!--    </goal>-->
<!--    <goal name="aspectwerkz:transform:bugshow">-->
<!--        <attainGoal name="aspectwerkz:metadata:bugshow"/>-->
<!--        <exec executable="${bin.dir}/aspectwerkz${executableSuffix}">-->
<!--            <arg line="-offline C:/temp/bugshow C:/temp/bugshow/aspectwerkz.xml C:/temp/bugshow/_metaData"/>-->
<!--        </exec>-->
<!--    </goal>-->
</project>


